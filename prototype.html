<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome to Altar - Knowledge Base Processing</title>
    <style>
   body, html {
    margin: 0;
    padding: 0;
    height: 100%;
    font-family: Arial, sans-serif;
    overflow: hidden;
}

.container {
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    background-color: #f0f0f0;
    transition: all 1s ease;
}

.welcome {
    font-size: 32px;
    font-weight: bold;
    margin-bottom: 20px;
}

.stages {
    display: none;
    justify-content: space-between;
    align-items: center;
    width: 300px;
    margin-bottom: 20px;
    transition: opacity 0.5s ease;
}

.stage {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background-color: #e0e0e0;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: all 0.5s ease;
    position: relative;
    z-index: 2;
}

.stage-icon {
    width: 30px;
    height: 30px;
    stroke: #999;
    fill: none;
}

.arrow {
    width: 20px;
    height: 20px;
    stroke: #999;
    fill: none;
}

.status {
    margin-top: 20px;
    font-size: 16px;
    color: #333;
    text-align: center;
    min-height: 20px;
}

.button {
    margin-top: 20px;
    padding: 10px 20px;
    font-size: 16px;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.3s;
}

.separated {
    display: flex;
    flex-direction: column;
    height: 100%;
    width: 100%;
}

.content-wrapper {
    display: flex;
    flex: 1;
    overflow: hidden;
}

.left-side, .right-side {
    display: flex;
    flex-direction: column;
    height: 100%;
    overflow-y: auto;
}

.left-side {
    width: 30%;
}

.right-side {
    width: 70%;
}

.center-divider {
    width: 10px;
    background-color: #ccc;
    height: 100%;
    position: relative;
    cursor: col-resize;
}

.center-arrow {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: #f0f0f0;
    border-radius: 50%;
    padding: 10px;
}

.hidden {
    display: none;
}

.floating {
    position: absolute;
    transition: all 1s ease;
}

.side-title {
    display: flex;
    align-items: center;
    padding: 10px;
    background-color: #e0e0e0;
    position: sticky;
    top: 0;
    z-index: 1;
}

.side-title .stage-icon {
    margin-right: 10px;
    width: 24px;
    height: 24px;
}

.side-content {
    padding: 20px;
    flex: 1;
}

.name-input {
    margin-top: 20px;
    padding: 10px;
    font-size: 16px;
    width: 300px;
}

.name-description {
    margin-top: 10px;
    font-size: 14px;
    color: #666;
}

.tab-list {
    list-style-type: none;
    padding: 0;
    margin: 0;
    overflow-y: auto;
    max-height: calc(100vh - 100px);
}

.tab-item {
    display: flex;
    align-items: center;
    padding: 10px;
    border-bottom: 1px solid #eee;
    cursor: move;
}

.tab-favicon {
    width: 16px;
    height: 16px;
    margin-right: 10px;
}

.tab-group {
    background-color: #f0f0f0;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
    cursor: pointer;
    transition: background-color 0.3s;
}

.tab-group:hover {
    background-color: #e0e0e0;
}

.tab-group-title {
    font-weight: bold;
    margin-bottom: 10px;
}

.tab-group-items {
    display: flex;
    flex-wrap: wrap;
}

.tab-group-item {
    display: flex;
    align-items: center;
    margin-right: 10px;
    margin-bottom: 5px;
}

.grouping-header {
    display: flex;
    align-items: center;
    padding: 20px;
    background-color: #f5f5f5;
    border-bottom: 1px solid #e0e0e0;
    transition: background-color 0.3s;
}

.grouping-header:hover {
    background-color: #e8e8e8;
}

.grouping-favicons {
    display: flex;
    margin-right: 12px;
}

.grouping-favicon {
    width: 20px;
    height: 20px;
    margin-right: 6px;
}

.grouping-name {
    flex-grow: 1;
    font-weight: bold;
}

.grouping-arrow {
    width: 24px;
    height: 24px;
    transition: transform 0.3s;
    fill: #3498db;
}

.grouping.expanded .grouping-arrow {
    transform: rotate(180deg);
}

.suggestions {
    display: block;
    padding: 20px;
    background-color: white;
    border: 1px solid #e0e0e0;
    border-top: none;
    border-bottom-left-radius: 8px;
    border-bottom-right-radius: 8px;
}

.suggestion {
    padding: 12px;
    margin-bottom: 10px;
    background-color: #f9f9f9;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.3s;
}

.suggestion:hover {
    background-color: #e8e8e8;
}

.add-grouping {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 30px;
    height: 30px;
    font-size: 20px;
    background-color: #3498db;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-weight: bold;
}

.tooltip-container {
    display: flex;
    align-items: center;
    margin-bottom: 20px;
}

.tooltip {
    flex-grow: 1;
    font-size: 14px;
    color: #666;
    font-style: italic;
    padding: 8px 12px;
    background-color: #f0f0f0;
    border-radius: 4px;
    margin: 0;
}

.add-grouping-button,
.remove-grouping-button {
    width: 30px;
    height: 30px;
    background-color: #3498db;
    color: white;
    border: none;
    border-radius: 50%;
    font-size: 20px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-left: 10px;
    transition: background-color 0.3s;
    flex-shrink: 0;
}

.add-grouping-button:hover,
.remove-grouping-button:hover {
    background-color: #2980b9;
}

.remove-grouping-button {
    display: none;
}

.input-row {
    display: none;
    margin-bottom: 20px;
    padding: 10px;
    background-color: #f5f5f5;
    border: 2px dashed #3498db;
    border-radius: 8px;
    align-items: center;
}

.dragged-favicons {
    display: flex;
    margin-right: 10px;
}

.dragged-favicon {
    width: 16px;
    height: 16px;
    margin-right: 5px;
}

.input-bar {
    flex-grow: 1;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
    font-size: 16px;
}

.left-side .tooltip {
    margin-bottom: 15px;
}

.grouping-actions {
    position: absolute;
    top: 10px;
    right: 10px;
    display: flex;
    gap: 5px;
}

.expand-grouping,
.remove-grouping {
    width: 24px;
    height: 24px;
    background-color: #f0f0f0;
    border: 1px solid #ccc;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background-color 0.3s;
}

.expand-grouping:hover,
.remove-grouping:hover {
    background-color: #e0e0e0;
}

.expand-icon,
.remove-icon {
    width: 16px;
    height: 16px;
    fill: none;
    stroke: #666;
    stroke-width: 2;
    stroke-linecap: round;
    stroke-linejoin: round;
}

.expand-grouping.expanded .expand-icon {
    transform: rotate(45deg);
}

.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    display: none;
}

.loading-stages {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 20px;
}

.loading-stage {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background-color: #e0e0e0;
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 0 10px;
    opacity: 0.5;
    transition: opacity 0.3s, background-color 0.3s;
}

.loading-stage.active {
    opacity: 1;
    background-color: #3498db;
}

.loading-stage-icon {
    width: 30px;
    height: 30px;
    fill: none;
    stroke: #fff;
    stroke-width: 2;
    stroke-linecap: round;
    stroke-linejoin: round;
}

.loading-status {
    color: #fff;
    font-size: 18px;
    text-align: center;
}

.add-grouping-plus {
    width: 150px;
    height: 150px;
    background-color: #f0f0f0;
    border: 2px dashed #3498db;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 48px;
    color: #3498db;
    cursor: pointer;
    transition: background-color 0.3s, transform 0.3s;
    flex-shrink: 0;
    margin-left: 10px;
}

.add-grouping-plus:hover {
    background-color: #e0e0e0;
    transform: scale(1.05);
}

.groupings-container {
    display: flex;
    overflow-x: auto;
    padding: 10px;
    gap: 20px;
    align-items: center;
    min-height: 300px;
}

.grouping {
    position: relative;
    flex: 0 0 auto;
    width: 400px;
    scroll-snap-align: start;
    margin-bottom: 0;
    position: relative;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    border-radius: 12px;
    overflow: hidden;
}

.active {
    background-color: #3498db;
}

.active .stage-icon {
    stroke: white;
}

.button {
    background-color: #3498db;
}

.button:hover {
    background-color: #2980b9;
}

.grouping:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.input-container {
    position: relative;
    margin-bottom: 20px;
}

.input-wrapper {
    display: flex;
    align-items: center;
    background-color: #f5f5f5;
    border-radius: 8px;
    padding: 8px 12px;
    transition: all 0.3s ease;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.input-wrapper:focus-within {
    box-shadow: 0 0 0 2px #3498db;
}

.dragged-favicons {
    display: flex;
    margin-right: 8px;
}

.dragged-favicon {
    width: 16px;
    height: 16px;
    margin-right: 4px;
}

.input-bar {
    flex-grow: 1;
    border: none;
    background: transparent;
    font-size: 14px;
    outline: none;
}

.clear-input {
    background: none;
    border: none;
    cursor: pointer;
    padding: 0;
    width: 20px;
    height: 20px;
    color: #999;
    transition: color 0.3s ease;
}

.clear-input:hover {
    color: #333;
}

.drop-area {
    top: 100%;
    left: 0;
    right: 0;
    background-color: #e0e0e0;
    border-radius: 0 0 8px 8px;
    padding: 10px;
    text-align: center;
    font-size: 14px;
    color: #666;
    transition: all 0.3s ease;
}

.drop-area.hidden {
    opacity: 0;
    transform: translateY(-10px);
    pointer-events: none;
}


  .content-wrapper {
    display: flex;
    height: 100vh;
  }

  .left-side {
    width: 30%; /* Adjust as needed */
    overflow-y: auto;
  }

  .right-side {
    width: 70%; /* Adjust as needed */
    position: relative;
  }

  .side-content {
    height: 100%;
    overflow-y: auto;
  }

  .expanded-view {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: white;
    z-index: 10;
    padding: 20px;
    box-sizing: border-box;
    overflow-y: auto;
    /*
    display: flex;
    flex-direction: column;*/
  }

  .expanded-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }

  .minimize-grouping {
    cursor: pointer;
  }

  .minimize-icon {
    width: 24px;
    height: 24px;
  }

  .main-canvas {
    height: 40vh;
    flex-grow: 1;
    overflow-y: auto; /* Make it scrollable */
    background-color: #f8f8f8;
    border: 1px solid #ddd;
    border-radius: 5px;
    margin-bottom: 20px;
    padding:10px;
  }

  .knowledge-source {
    background-color: #e8f6ff;
    border: 2px solid #3498db;
    border-radius: 5px;
    padding: 10px;
    margin-top: 20px;
  }

  .tabs-section {
    margin-bottom: 10px;
  }

  .tabs-used, .suggested-tabs {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
  }

  .action-chat-bar {
    display: flex;
    align-items: center;
    background-color: #e8f6ff;
    border: 2px solid #3498db;
    border-radius: 20px;
    padding: 10px;
  }


  .action-chat-container {
    padding: 20px;
    background-color: #e8f6ff;
    border: 2px solid #3498db;
  }

  .action-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }

  .action-buttons button {
    background-color: #2ecc71;
    color: white;
    border: none;
    border-radius: 15px;
    padding: 5px 15px;
    font-size: 14px;
    cursor: pointer;
  }

  .chat-input {
    flex-grow: 1;
    border: 1px solid #ccc;
    border-radius: 15px;
    padding: 5px 15px;
    font-size: 14px;
    margin-left: 10px;
  }

 .action-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 15px;
  }

  .action-buttons button {
    background-color: #2ecc71;
    color: white;
    border: none;
    border-radius: 15px;
    padding: 8px 15px;
    font-size: 14px;
    cursor: pointer;
  }

  .chat-bar {
    display: flex;
  }

  .chat-input {
    flex-grow: 1;
    border: 1px solid #ccc;
    border-radius: 20px;
    padding: 10px 15px;
    font-size: 14px;
  }

  .hidden {
    display: none;
  }

    #name-screen {
        flex-direction: column;
        align-items: center;
        text-align: center;
        width: 100%;
        max-width: 400px; /* Adjust as needed */
    }

    #name-screen h2 {
        margin-bottom: 20px;
    }

    .name-input {
        width: 100%;
        max-width: 300px;
        margin-bottom: 10px;
    }

    .name-description {
        margin-bottom: 20px;
    }

    #loading-screen {
        text-align: center;
    }

    #greeting {
        margin-bottom: 40px;
        font-size: 24px;
        color: #333;
    }


  .suggested-tab {
    display: flex;
    align-items: center;
    background-color: #f0f0f0;
    border: 1px solid #3498db;
    border-radius: 12.5px;
    padding: 5px 10px;
    font-size: 12px;
    cursor: pointer;
    margin: 5px;
  }

  .suggested-tab-favicon {
    width: 16px;
    height: 16px;
    margin-right: 5px;
  }
 .loading-overlay-spin {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 10000; /* Ensure it's above everything else */
  }

  .loading-spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #3498db;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .loading-overlay-spin p {
    color: white;
    margin-top: 10px;
  }

  .loading-overlay-spin.hidden {
    display: none;
  }

  .action-buttons {
    display: flex;
    justify-content: center;
    margin-bottom: 20px;
  }

  .action-button {
    background-color: #2ecc71;
    color: white;
    border: none;
    border-radius: 5px;
    padding: 10px 20px;
    margin: 0 10px;
    cursor: pointer;
  }

.placeholder-text {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  height: 100%;
  text-align: center;
  color: #666;
  font-size: 18px;
  line-height: 1.6;
}

.placeholder-text p {
  margin: 10px 0;
}

  
    </style>
</head>
<body>
    <div id="userInfo" style="position: fixed; top: 10px; right: 20px; z-index: 1000; display: none;">
        <span id="userName"> </span>
        <button id="resetButton" style="background: none; border: none; cursor: pointer; margin-left: 10px;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
                <path d="M3 3v5h5"></path>
            </svg>
        </button>
    </div>
    <div class="container">
        <div class="welcome">Welcome to Altar</div>
        <button id="start-button" class="button">Let's Get Started</button>
        
        <div id="name-screen" class="hidden">
            <h2>Hello! What's your name?</h2>
            <input type="text" id="name-input" class="name-input" placeholder="Enter your name">
            <div class="name-description">Please enter your first name or the name you prefer to be called.</div>
            <button id="continue-button" class="button">Continue</button>
        </div>

        <div id="loading-screen" class="hidden">
            <h2 id="greeting"></h2>
            <div class="stages">
                <div id="stage0" class="stage">
                    <svg class="stage-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                </div>
                <svg class="arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
                </svg>
                <div id="stage1" class="stage">
                    <svg class="stage-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"></path>
                    </svg>
                </div>
                <svg class="arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
                </svg>
                <div id="stage2" class="stage">
                    <svg class="stage-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
                    </svg>
                </div>
            </div>
            <div class="status hidden">Ready to start</div>
        </div>
    </div>
    <div class="loading-overlay">
        <div class="loading-stages">
            <div class="loading-stage" id="stage0">
                <svg class="loading-stage-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
            </div>
            <div class="loading-stage" id="stage1">
                <svg class="loading-stage-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"></path>
                </svg>
            </div>
            <div class="loading-stage" id="stage2">
                <svg class="loading-stage-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                    <path d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
                </svg>
            </div>
        </div>
        <div class="loading-status">Processing your request...</div>
    </div>
<div id="loading-overlay-spin" class="loading-overlay hidden">
  <div class="loading-spinner"></div>
  <p>Loading...</p>
</div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    <script>
        // DOM Elements
const container = document.querySelector('.container');
const stages = document.querySelectorAll('.stage');
const stagesContainer = document.querySelector('.stages');
const status = document.querySelector('.status');
const startButton = document.getElementById('start-button');
const nameScreen = document.getElementById('name-screen');
const nameInput = document.getElementById('name-input');
const loadingScreen = document.getElementById('loading-screen');
const continueButton = document.getElementById('continue-button');
const welcome = document.querySelector('.welcome');
const loadingOverlay = document.querySelector('.loading-overlay');
const loadingStages = document.querySelectorAll('.loading-stage');
const loadingStatus = document.querySelector('.loading-status');

// State
let currentLoadingStage = 0;  // Add this line
let currentStage = 0;
let userName = '';
let isAtEnd = false;
const BUFFER = 50;

// Add this variable to keep track of the last selected action
let lastSelectedAction = '';

// Constants
const API_URL = 'https://161.35.13.92:3000';
const messages = [
    "Pulling your tabs...",
    "Processing data...",
    "Generating suggestions..."
];

// Helper Functions
function $(selector) {
    return document.querySelector(selector);
}

function $$(selector) {
    return document.querySelectorAll(selector);
}

function hide(element) {
    element.classList.add('hidden');
}

function show(element) {
    element.classList.remove('hidden');
}

function debounce(func, wait) {
    let timeout;
    return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func(...args), wait);
    };
}

// App Flow Functions
function proceedToNameScreen() {
    hide(startButton);
    hide(welcome);
    show(nameScreen);
    nameInput.focus();
}


function getGreeting() {
    const hour = new Date().getHours();
    if (hour < 12) return "Good morning";
    if (hour < 18) return "Good afternoon";
    return "Good evening";
}


function updateStage() {
    stages.forEach((stage, index) => {
        stage.classList.toggle('active', index === currentStage);
    });
    status.textContent = messages[currentStage];
    currentStage++;
    if (currentStage >= 3) {
        setTimeout(separatePage, 1000);
    } else {
        setTimeout(updateStage, 1500);
    }
}


function setupResetButton() {
    const resetButton = document.getElementById('resetButton');
    if (resetButton) {
        resetButton.addEventListener('click', () => {
            if (confirm('Are you sure you want to reset? This will clear your name and return to the welcome screen.')) {
                clearSavedName();
                location.reload();
            }
        });
    }
}




function updateNameDisplay(name) {
    const userNameElement = document.getElementById('userName');
    if (userNameElement) {
        userNameElement.textContent = name;
    }
}

function showUserInfo() {
    const userInfo = document.getElementById('userInfo');
    if (userInfo) {
        userInfo.style.display = 'flex';
    }
}


function separatePage() {
    stages.forEach(stage => stage.classList.remove('active'));
    const stage0 = $('#stage0');
    const stage2 = $('#stage2');
    const stage0Rect = stage0.getBoundingClientRect();
    const stage2Rect = stage2.getBoundingClientRect();
    const tabsData = [
        { shortTitle: "Sharpen your thinking", favicon: "https://obsidian.md/favicon.svg" },
        { shortTitle: "Daylight - A More Caring Computer", favicon: "https://daylightcomputer.com/favicon.ico" },
        { shortTitle: "Perplexity AI", favicon: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABwAAAAcCAMAAABF0y+mAAAAQlBMVEUAAAAAAAAAAAAAAABXV1aFhYS+vrtcXFv///+enpzGxsTS0s8rKyrq6ufx8e4dHRyzs7JNTUz9/fpxcXBAQD/U1NKCxwi2AAAAA3RSTlMOx/tePIPJAAAA6klEQVR4AX3T0XqGIAgG4IrUzwxSc/d/q5M2W9n+OICn5z2AUIdhnOjfmMZq9DHGYfqM0/BTZ3MUa49iHB3REF7Lsmj2mDtEaBjwwJVlU9yE1wcSRSRrEyJRhwk1ucycdRakCwoLRGrOuSYR1HwivNHYGeDdaHg0bD0WCUHCOUNDp5lZp+VctP0dC75IkQJMjztsW0JEvOFcuvVde6YC+kNCSRdkxlZrESnt+0Tvo6JDznCK0fvr+ioaeGs9TLc+RfIw2tPAPxdvsZOi/tTzsFObNqHHvFJDWrO7YVFrSFv5xber+XqpX5/DN+2hEGslprvPAAAAAElFTkSuQmCC" },
        { shortTitle: "AI Summaries and Insights Creator", favicon: "https://www.elmo.chat/icon.svg?3526168b212a3fc1" },
        { shortTitle: "altar.ai", favicon: "https://images.squarespace-cdn.com/content/v1/6631d577f1ec4807b197218a/7a8420a7-bf6a-4b8d-9d63-d2f7c5ce6a60/favicon.ico?format=100w" },
        { shortTitle: "Your ChatGPT AI Assistant for Anywhere", favicon: "https://monica.im/logo.png" },
        { shortTitle: "Twitter", favicon: "https://abs.twimg.com/favicons/twitter.3.ico" },
        { shortTitle: "LinkedIn", favicon: "https://static.licdn.com/aero-v1/sc/h/3loy7tajf3n0cho89wgg0fjre" },
        { shortTitle: "ChatGPT", favicon: "https://cdn.oaistatic.com/_next/static/media/favicon-32x32.630a2b99.png" },
        { shortTitle: "Figma - Altar Redesign", favicon: "https://static.figma.com/app/icon/1/favicon.svg" },
        { shortTitle: "GitHub - altar-bff/pkg/api/handle_tab_get.go at accept", favicon: "https://github.githubassets.com/favicons/favicon.svg" },
        { shortTitle: "Python Pandas", favicon: "https://pandas.pydata.org/static/img/favicon.ico" },
        { shortTitle: "Pokemon Museum", favicon: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAADBklEQVR4AWJAA3ycXFwxmlpam/3c3V8mhIT8i/IP+G5jY3NJXEa6m4GRUQ+ohhFdE6BucgiwI4iiaAdj27Zt27Zt2za3sW3btm0bY+OmfsdqlOs8U5ycnIxOSV1dfXldWXn/xR078aqlA28Dw/A6OAL30rOxJr9wyt/T8zYXL28MOcv84zITExOjUzAzMzu4e+MmjB4/ieGUTPQoa+OTmBw+k79HQgF9uqZ4lJaNgti4Hh4BgQxyZ9Z3BoeqqurCXZs2YfLEKQwkpOKzoiZ6VbQxYGSJfnKxR0aFhjH6l2Q/OSzsFTV7tp2QsDBFzJoRUFVZ+Xnsxi0MVdSiR8cYH/xDsb+wBB1p6ViYk4t72fno1TPFJ3F59BL42fwi6BsYbGBYTymrqKw/e+gQJtasR5+dKz4ERaA2NQ0WNjZISEqCX2AAXJydcaq4DL1qevgkIotPbr7Ij4l5SwCWlLePz7MPFy5irLYJIx5+2FZcCht7e+zevRsbN27Evn37UFZejjBfP3wgvhnQM8OIsxeWF5eM8QoJ5VMa6uqTOUnJKIyKRlFoGMyNjFBRUYF169bBwsICxsbGOEQ01NbRQXJAIIrIXxwcAn9XN3BycXVSGhoak7m5uSgqKUFJaSnMzc1pwLJly8DPzw9dXV0aoEMAScnJyMjKRGx8PFxdXcHFAHh7ez/7+PEjvj87d+6EDbGf9DRkz549KCXgiIgIPHv2DHPnzoWPjw+I0DEhIaE8SllZef3Zs2d/AEZGRlBfXw+SfUhMTISfnx9cXFxw4sQJnDx5kr5McoYBpJ34NYxVVZ8nJiZ+gxw9ehTd3d1YunQpHj16hFu3bqGEmKmkpIRkYoq+vj4dxp+JtGsX/vfcvXsX5SQS5BwCAwMRFBT0etasWXaCgoK/pzLD3l81mZqawuXLl5GXl0f7JSoqCpGRkT0Cf6QyxcHB8aOYiP39V65coR3GALa1tSEzMxPp6elTbm5ut3n/LKa/ypmNLVJNTW2Hu7v7O+KwaQ8PD7qcJSUlO2b8o5y/AGcd70tIfUX/AAAAAElFTkSuQmCC" },
        { shortTitle: "Japan Rail Pass", favicon: "https://www.jrpass.com/favicon.ico" },
        { shortTitle: "Tokyo Travel Guide", favicon: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABwAAAAcCAMAAABF0y+mAAAAilBMVEUiJjMbIC4fIzEXHCsAABlRU1thY2o2OUQAABcLEiRcXmUACyATGSlXWmH3+Pj////U1NYAAByChImjpKft7u7Fxsjd3d4AAAB2eH6anKDl5eYAABNNT1i4ubyTlJlDRk/Nzc9tb3WNjpMpLTl9foQ8P0mPkJRKTVU0N0IAAA2ur7IoLDgAAAi2t7pxw6hgAAABaElEQVR4AbXSRZaEQBBF0YzA9eFa7rr/5ZVw2uf9cS6km/+MiH7cWPqHLNtxPf/1NgjCUKNfFicpkInmBUDp/zD1oKqhaTtoMuijWD8xKBna0YNZxrxtF6TLhfn0fEUZWXnimpS19S7HzrL5Zmt9ot0VReGluJbZdrt9k0Llyge2A1C8UU2K6Zgno3z+6e8OAzs4im5BT3EkZko0Z34O2op1uQ+DIIFAv4cgHDiENbV0pOvXQ2ab7wSXsu+7tYqpeGcvP1DtTZbVbmw06rPsYsTo6+UnamDneXDNXzfncxyriEanfOIoAyhhZTguGarz9v1Und6q1xNhRLFlwzKdtxR1Nsz9aj5NjxicPafbcKGiDTZwYneeZ7mZfp3w/MKBTTBWdUs33r8xxm3pWfbEflO2adk2dTThlsS/Q3VidqZuh8tYADMxU5KtyY9hpMlVvMQ67jXwXLE+19f7kOmqYuQ9Btbr9F95AqHNHmLA/W87AAAAAElFTkSuQmCC" },
        { shortTitle: "Kyoto Attractions", favicon: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABwAAAAcCAMAAABF0y+mAAAAWlBMVEX/////9PT/4OD/6Oj/+vr/qan/S0v/Kir/IyP/NTX/dnb/3Nz/zc3/AAD/ior/xMT/6+v/lZX/e3v/trb/FRX/l5f/MDD/r6//RUX/g4P/ZWX/UFD/HR3/u7s2SqvRAAAAdklEQVR4Ac3RtREAQRADwWdmxvzDfIbVkX3jdsmSoXWmZUvEcT0/CMIoFlgSpE+ZyVqe/kWMFimtRKxSqIChn8qndYPoUWxTrKNYqrBvEAeKVoA4GrQJ0QK0wCoDc4nNhcHUfzYJfrOrbmmaYF4ljyZ1Divt2gEMeQxnsiajxQAAAABJRU5ErkJggg==" }
    ];


    const groupings = [
        {
            name: "AI Productivity Tools",
            favicons: ["https://obsidian.md/favicon.svg", "https://www.elmo.chat/icon.svg?3526168b212a3fc1", "https://monica.im/logo.png"],
            suggestions: [
            "Explore more AI productivity tools",
            "Create Research report",
            "Check out Elmo chat",
            "Look into Monica features"
            ]
        },
        {
            name: "Social Media",
            favicons: ["https://abs.twimg.com/favicons/twitter.3.ico", "https://static.licdn.com/aero-v1/sc/h/3loy7tajf3n0cho89wgg0fjre"],
            suggestions: [
                "Check latest updates",
                "Engage with your network",
                "Share your recent work",
                "Find new connections"
            ]
        },
    ];

    container.innerHTML = `
        <div class="separated">
            <div class="content-wrapper">
                <div class="left-side">
                    <div class="side-title">
                        <svg class="stage-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <h2>Your Tabs</h2>
                    </div>
                    <div class="side-content">
                        <div class="tooltip">Pulling your tabs...</div>
                        <ul class="tab-list">
                            ${tabsData.map(tab => `
                                <li class="tab-item" draggable="true" data-favicon="${tab.favicon}"data-title="${tab.shortTitle}">
                                    <img src="${tab.favicon}" alt="${tab.shortTitle}" class="tab-favicon">
                                    ${tab.shortTitle}
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                </div>
                <div class="center-divider" id="divider">
                    <div class="center-arrow">
                        <svg class="arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="width: 40px; height: 40px;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
                        </svg>
                    </div>
                </div>
                <div class="right-side">
                    <div class="side-title">
                        <svg class="stage-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
                        </svg>
                        <h2>Assistant</h2>
                    </div>
                    <div class="side-content">
                        <div class="input-container">
                            <div class="input-wrapper">
                                <div class="dragged-favicons"></div>
                                <input type="text" class="input-bar" placeholder="Type what you want to accomplish or drag tabs here...">
                                <button class="clear-input">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M3 6h18"></path>
                                        <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                                        <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                                    </svg>
                                </button>
                            </div>
                            <div class="drop-area hidden">Drop to add tab</div>
                        </div>
                        <div class="tooltip-container">
                            <div class="tooltip">Based on your data, here's what we think you want to accomplish:</div>
                        </div>

                        <div class="groupings-container">
                            ${groupings.map(grouping => `
                                <div class="grouping" data-name="${grouping.name}">
                                    <div class="grouping-header">
                                        <div class="grouping-favicons">
                                            ${grouping.favicons.map(favicon => `
                                                <img src="${favicon}" alt="" class="grouping-favicon">
                                            `).join('')}
                                        </div>
                                        <div class="grouping-name">${grouping.name}</div>
                                    </div>
                                    <div class="suggestions">
                                        ${grouping.suggestions.map(suggestion => `
                                            <div class="suggestion">${suggestion}</div>
                                        `).join('')}
                                    </div>
                                    <div class="grouping-actions">
                                        <div class="expand-grouping">
                                            <svg class="expand-icon" viewBox="0 0 24 24">
                                                <path d="M4 4L9 9M4 4V8M4 4H8M20 4L15 9M20 4V8M20 4H16M4 20L9 15M4 20V16M4 20H8M20 20L15 15M20 20V16M20 20H16"/>
                                            </svg>
                                        </div>
                                        <div class="remove-grouping">
                                            <svg class="remove-icon" viewBox="0 0 24 24">
                                                <path d="M18 6L6 18M6 6l12 12"/>
                                            </svg>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                            <div class="add-grouping-plus">+</div>
                        </div>
                        <div class="expanded-view hidden">
                            <div class="expanded-header">
                              <h2 class="expanded-title"></h2>
                              <div class="minimize-grouping">
                                <svg class="minimize-icon" viewBox="0 0 24 24">
                                  <path d="M8 3v3a2 2 0 01-2 2H3m18 0h-3a2 2 0 01-2-2V3m0 18v-3a2 2 0 012-2h3M3 16h3a2 2 0 012 2v3"/>
                                </svg>
                              </div>
                            </div>
                            <div class="main-canvas">
                              <!-- Dynamic content will be inserted here -->
                            </div>
                             <div class="action-chat-container">
                                <div class="action-buttons"></div>
                                <div class="chat-bar">
                                  <input type="text" class="chat-input" placeholder="Type a message...">
                                </div>
                              </div>
                            <div class="knowledge-source">
                              <div class="tabs-section">
                                <h3>Tabs Used: </h3>
                                <div class="tabs-used"></div>
                              </div>
                              <div class="tabs-section">
                                <h3>Suggested Tabs: </h3>
                                <div class="suggested-tabs"></div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                    </div>
                </div>
            </div>
        </div>
    `;

    updateNameDisplay(userName);
    showUserInfo();

    //animateStages(stage0, stage2, stage0Rect, stage2Rect);
    setupDividerDrag();
    setupGroupingInteractions();
    setupTabDragAndDrop();
    setupInputBar();
    setupExpandedView();
}

function animateStages(stage0, stage2, stage0Rect, stage2Rect) {
    const floatingStage0 = stage0.cloneNode(true);
    const floatingStage2 = stage2.cloneNode(true);
    
    [floatingStage0, floatingStage2].forEach(stage => {
        stage.classList.add('floating');
        document.body.appendChild(stage);
    });

    floatingStage0.style.left = `${stage0Rect.left}px`;
    floatingStage0.style.top = `${stage0Rect.top}px`;
    floatingStage2.style.left = `${stage2Rect.left}px`;
    floatingStage2.style.top = `${stage2Rect.top}px`;

    setTimeout(() => {
        floatingStage0.style.left = '5%';
        floatingStage0.style.top = '25px';
        floatingStage2.style.left = '40%';
        floatingStage2.style.top = '25px';
    }, 100);

    setTimeout(() => {
        [floatingStage0, floatingStage2].forEach(stage => stage.remove());
    }, 1100);
}

function setupDividerDrag() {
    const divider = $('#divider');
    const leftSide = $('.left-side');
    const rightSide = $('.right-side');
    let isDragging = false;

    divider.addEventListener('mousedown', () => {
        isDragging = true;
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', stopDrag);
    });

    function drag(e) {
        if (!isDragging) return;
        const containerRect = container.getBoundingClientRect();
        const newX = e.clientX - containerRect.left;
        const leftWidth = (newX / containerRect.width) * 100;
        const rightWidth = 100 - leftWidth;

        if (leftWidth > 20 && rightWidth > 20) {
            leftSide.style.width = `${leftWidth}%`;
            rightSide.style.width = `${rightWidth}%`;
        }
    }

    function stopDrag() {
        isDragging = false;
        document.removeEventListener('mousemove', drag);
        document.removeEventListener('mouseup', stopDrag);
    }
}


function showInputRow() {
    //$('.input-row').style.display = 'flex';
   // $('.input-bar').focus();
   alert("TO DO: Generating another card suggestion")
}

function hideInputRow() {
  //  $('.input-row').style.display = 'none';
}

function setupGroupingInteractions() {
    const groupingsContainer = $('.groupings-container');
    
    groupingsContainer.addEventListener('click', (e) => {
        const grouping = e.target.closest('.grouping');
        if (!grouping) return;

        const expandButton = e.target.closest('.expand-grouping');
        const removeButton = e.target.closest('.remove-grouping');
        const groupingHeader = e.target.closest('.grouping-header');
        
        if (expandButton || groupingHeader) {
            expandGrouping(grouping);
        } else if (removeButton) {
            grouping.remove();
        }
    });

    function expandGrouping(grouping) {
        grouping.classList.toggle('expanded');
        const expandIcon = grouping.querySelector('.expand-grouping');
        if (expandIcon) {
            //alert("TO DO: Expanding card to fullscreen")
            expandIcon.classList.toggle('expanded');
        }
    }

    const addGroupingButton = $('.add-grouping-button');
    const removeGroupingButton = $('.remove-grouping-button');
    const addGroupingPlus = $('.add-grouping-plus');

    //addGroupingButton.addEventListener('click', showInputRow);
    //removeGroupingButton.addEventListener('click', hideInputRow);
    addGroupingPlus.addEventListener('click', showInputRow);

    //groupingsContainer.addEventListener('scroll', debounce(updateButtonVisibility, 50));
    //updateButtonVisibility();

    function updateButtonVisibility() {
        if (!isAtEnd && isScrolledToEnd(groupingsContainer)) {
            isAtEnd = true;
            addGroupingPlus.style.display = 'flex';
            addGroupingButton.style.display = 'none';
        } else if (isAtEnd && isScrolledBackFromEnd(groupingsContainer)) {
            isAtEnd = false;
            addGroupingPlus.style.display = 'none';
            addGroupingButton.style.display = 'flex';
        }
    }

    function isScrolledToEnd(element) {
        return element.scrollLeft + element.clientWidth >= element.scrollWidth - 100;
    }

    function isScrolledBackFromEnd(element) {
        return element.scrollLeft + element.clientWidth < element.scrollWidth - 100 - BUFFER;
    }
}


function dragOver(e) {
    e.preventDefault();
    this.classList.add('drag-over');
}

function drop(e) {
    e.preventDefault();
    const grouping = e.target.closest('.grouping');
    if (grouping) {
        grouping.classList.remove('drag-over');
        const tabId = e.dataTransfer.getData('text/plain');
        const favicon = e.dataTransfer.getData('favicon');
        const title = e.dataTransfer.getData('title');

        const tabData = { url: favicon, title: title };
        const faviconContainer = grouping.querySelector('.grouping-favicons');
        const newFavicon = document.createElement('img');

        newFavicon.src = favicon;
        newFavicon.alt = title;
        newFavicon.classList.add('grouping-favicon');
        faviconContainer.appendChild(newFavicon);

        const tabToRemove = document.getElementById(tabId);
        if (tabToRemove) {
            tabToRemove.remove();
        }

        //startLoading();
        updateSuggestions(grouping, tabData);
    }
}

function setupTabDragAndDrop() {
    const tabItems = $$('.tab-item');
    const groupingElements = $$('.grouping');
    const draggedFavicons = $('.dragged-favicons');
    //const inputRow = $('.input-row');
    const inputBar = $('.input-bar');

    tabItems.forEach(tab => {
        tab.addEventListener('dragstart', dragStart);
        tab.addEventListener('dragend', dragEnd);
    });

    groupingElements.forEach(grouping => {
        grouping.addEventListener('dragover', dragOver);
        grouping.addEventListener('drop', drop);
    });

    //inputRow.addEventListener('drop', dropIntoInputRow);
    inputBar.addEventListener('keypress', createNewGrouping);

    const dropArea = document.querySelector('.drop-area');

    function dragStart(e) {
        e.dataTransfer.setData('text/plain', e.target.textContent);
        e.dataTransfer.setData('favicon', e.target.dataset.favicon);
        e.dataTransfer.setData('title', e.target.dataset.title);
        e.dataTransfer.setData('tabId', e.target.id);
        dropArea.classList.remove('hidden');
    }

    function dragEnd(e) {
        e.target.classList.remove('hide');
        dropArea.classList.add('hidden');
    }

    function dropIntoInputRow(e) {
        e.preventDefault();
        this.classList.remove('drag-over');
        const favicon = e.dataTransfer.getData('favicon');
        const tabId = e.dataTransfer.getData('tabId');
        const title = e.dataTransfer.getData('title');
        
        const newFavicon = document.createElement('img');
        newFavicon.src = favicon;
        newFavicon.alt = title;
        newFavicon.classList.add('dragged-favicon');
        draggedFavicons.appendChild(newFavicon);

        const tabToRemove = document.getElementById(tabId);
        if (tabToRemove) {
            tabToRemove.remove();
        }
    }
}

async function updateSuggestions(groupingElement, newTabData) {
    startLoading();
    try {
        const groupingName = groupingElement.querySelector('.grouping-name').textContent;
        const existingFavicons = Array.from(groupingElement.querySelectorAll('.grouping-favicon'))
            .map(favicon => ({ url: favicon.src, title: favicon.alt }));
        
        const allTabs = [...existingFavicons, newTabData];

        const response = await fetch(`${API_URL}/api/gpt`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                title: groupingName,
                tabs: allTabs,
                prompt: `Given the title "${groupingName}" and the following tabs: ${JSON.stringify(allTabs)}, I want you to first breakdown the task and then suggest 4 short and simple actions (3-5 words each) the user might want to take. Give me each action in a new line, without any additional numbers or text.`
            }),
        });

        if (!response.ok) {
            throw new Error('Failed to update suggestions');
        }

        const result = await response.json();
        const aiResponse = result.choices[0].message.content;
        
        const newSuggestions = aiResponse.split('\n').filter(line => line.trim() !== '');
        const suggestionsContainer = groupingElement.querySelector('.suggestions');
        suggestionsContainer.innerHTML = newSuggestions.map(suggestion => 
            `<div class="suggestion">${suggestion}</div>`
        ).join('');

    } catch (error) {
        console.error('Error updating suggestions:', error);
    } finally {
        stopLoading();
    }
}
// Utility function to make API calls
async function fetchAPI(endpoint, data) {
    const response = await fetch(`${API_URL}${endpoint}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
    });

    if (!response.ok) {
        throw new Error(`API call failed: ${endpoint}`);
    }

    return response.json();
}

async function getRelevantTabs(title) {
    const allTabs = Array.from($$('.tab-item')).map(tab => ({
        title: tab.textContent.trim(),
        url: tab.dataset.favicon
    }));

    const result = await fetchAPI('/api/relevant-tabs', { title, allTabs });
    
    const relevantIndices = result.choices[0].message.content
        .split('\n')
        .filter(line => line.trim() !== '')
        .map(line => parseInt(line.trim(), 10))
        .filter(index => !isNaN(index) && index < allTabs.length);

    return relevantIndices.map(index => allTabs[index]);
}

async function getSuggestions(title, tabs) {
    const prompt = title
        ? `Given the title "${title}" and the following tabs: ${JSON.stringify(tabs)}, I want you to first breakdown the task and then suggest 4 short and simple actions (3-5 words each) the user might want to take. Give me each action in a new line, without any additional numbers or text.`
        : `Given the following tabs: ${JSON.stringify(tabs)}, suggest a short title (2-4 words) for this group and then I want you to first breakdown the task and then 4 short and simple actions (3-5 words each) the user might want to take. Give me the title and each action in a new line, without any additional numbers or text.`;

    const result = await fetchAPI('/api/gpt', { title, tabs, prompt });
    return result.choices[0].message.content.split('\n').filter(line => line.trim() !== '');
}

async function createNewGrouping(e) {
    if (e.key === 'Enter') {
        startLoading();
        try {
            const inputBar = $('.input-bar');
            const draggedFavicons = $('.dragged-favicons');
            const inputTitle = inputBar.value.trim();
            let relevantTabs = Array.from(draggedFavicons.children).map(favicon => ({
                title: favicon.alt,
                url: favicon.src
            }));

            if (relevantTabs.length === 0) {
                relevantTabs = await getRelevantTabs(inputTitle);
            }

            const suggestions = await getSuggestions(inputTitle, relevantTabs);
            createGroupingElement(inputTitle || suggestions[0], relevantTabs, suggestions.slice(inputTitle ? 0 : 1));

            inputBar.value = '';
            draggedFavicons.innerHTML = '';
            hideInputRow();
            setupGroupingInteractions();
            setupExpandedView();

        } catch (error) {
            console.error('Error:', error);
            alert('Failed to create grouping. Please try again.');
        } finally {
            stopLoading();
        }
    }
}

function createGroupingElement(title, tabs, suggestions) {
    const newGrouping = document.createElement('div');
    newGrouping.classList.add('grouping');
    newGrouping.innerHTML = `
        <div class="grouping-header">
            <div class="grouping-favicons">
                ${tabs.map(tab => `<img src="${tab.url}" alt="${tab.title}" title="${tab.title}" class="grouping-favicon">`).join('')}
            </div>
            <div class="grouping-name">${title}</div>
        </div>
        <div class="suggestions">
            ${suggestions.map(suggestion => `<div class="suggestion">${suggestion}</div>`).join('')}
        </div>
        <div class="grouping-actions">
            <div class="expand-grouping">
                <svg class="expand-icon" viewBox="0 0 24 24">
                    <path d="M4 4L9 9M4 4V8M4 4H8M20 4L15 9M20 4V8M20 4H16M4 20L9 15M4 20V16M4 20H8M20 20L15 15M20 20V16M20 20H16"/>
                </svg>
            </div>
            <div class="remove-grouping">
                <svg class="remove-icon" viewBox="0 0 24 24">
                    <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
            </div>
        </div>
    `;

    const groupingsContainer = $('.groupings-container');
    if (groupingsContainer.firstChild) {
        groupingsContainer.insertBefore(newGrouping, groupingsContainer.firstChild);
    } else {
        groupingsContainer.appendChild(newGrouping);
    }
    groupingsContainer.scrollTo({
        left: 0,
        behavior: 'smooth'
    });

    newGrouping.addEventListener('dragover', dragOver);
    newGrouping.addEventListener('drop', drop);
}
let loadingInterval;

function startLoading() {
    loadingOverlay.style.display = 'flex';
    currentLoadingStage = 0;
    updateLoadingStage();
    loadingInterval = setInterval(updateLoadingStage, 1000); // Change stage every second
}

function stopLoading() {
    loadingOverlay.style.display = 'none';
    clearInterval(loadingInterval);
}

function showLoading() {
    console.log('showing loading')
  document.getElementById('loading-overlay-spin').classList.remove('hidden');
    startLoading()
}

function hideLoading() {
    console.log('hiding loading')
  document.getElementById('loading-overlay-spin').classList.add('hidden');    
    stopLoading()
}

function updateLoadingStage() {
    loadingStages.forEach((stage, index) => {
        stage.classList.toggle('active', index === currentLoadingStage);
    });
    loadingStatus.textContent = messages[currentLoadingStage];
    console.log(currentLoadingStage)
    currentLoadingStage = (currentLoadingStage+1 ) %3;
    /*
    if (currentLoadingStage >= loadingStages.length) {
        stopLoading();
    }*/
}

// Event Listeners
startButton.addEventListener('click', proceedToNameScreen);
continueButton.addEventListener('click', proceedToLoadingScreen);
nameInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') proceedToLoadingScreen();
});


function saveName(name) {
    localStorage.setItem('altarUserName', name);
}

function getSavedName() {
    return localStorage.getItem('altarUserName');
}

function clearSavedName() {
    localStorage.removeItem('altarUserName');
}



// Modify the existing proceedToLoadingScreen function
function proceedToLoadingScreen() {
    userName = nameInput.value.trim();
    if (userName) {
        saveName(userName); // Save the name
        hide(nameScreen);
        show(loadingScreen);
        const greeting = document.getElementById('greeting');
        greeting.textContent = `${getGreeting()}, ${userName}!`;
        show(stagesContainer);
        stagesContainer.style.display = 'flex';
        show(status);
        status.style.opacity = '1';
        updateStage();
    } else {
        alert('Please enter your name.');
    }
}

// Modify the existing initializeAppWithSavedName function
function initializeAppWithSavedName() {
    const savedName = getSavedName();
    if (savedName) {
        userName = savedName;
        updateNameDisplay(userName);
        separatePage(); // Directly go to the main interface
    } else {
        show(startButton);
        show(welcome);
    }
}

function setupInputBar() {
    const inputContainer = document.querySelector('.input-container');
    const inputWrapper = document.querySelector('.input-wrapper');
    const inputBar = document.querySelector('.input-bar');
    const draggedFavicons = document.querySelector('.dragged-favicons');
    const dropArea = document.querySelector('.drop-area');
    const clearInput = document.querySelector('.clear-input');
    console.log(inputWrapper)
    inputWrapper.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropArea.classList.remove('hidden');
    });

    inputWrapper.addEventListener('dragleave', () => {
        dropArea.classList.add('hidden');
    });

    inputWrapper.addEventListener('drop', (e) => {
        e.preventDefault();
        dropArea.classList.add('hidden');
        
        const tabId = e.dataTransfer.getData('tabId');
        const favicon = e.dataTransfer.getData('favicon');
        const title = e.dataTransfer.getData('title');

        addFaviconToInput(favicon, title);
        
        const tabToRemove = document.getElementById(tabId);
        if (tabToRemove) {
            tabToRemove.remove();
        }
    });

    clearInput.addEventListener('click', () => {
        inputBar.value = '';
        draggedFavicons.innerHTML = '';
    });

    function addFaviconToInput(faviconUrl, title) {
        console.log("hi")
        const newFavicon = document.createElement('img');
        newFavicon.src = faviconUrl;
        newFavicon.alt = title;
        newFavicon.classList.add('dragged-favicon');
        draggedFavicons.appendChild(newFavicon);
    }
}
function setupExpandedView() {
    const groupings = document.querySelectorAll('.grouping');
    const expandedView = document.querySelector('.expanded-view');
    const minimizeButton = expandedView.querySelector('.minimize-grouping');
    
    groupings.forEach(grouping => {
      const expandButton = grouping.querySelector('.expand-grouping');
      expandButton.addEventListener('click', () => expandGrouping(grouping, expandedView));
    });
    
    minimizeButton.addEventListener('click', () => minimizeGrouping(expandedView));
    
    setupDragAndDrop(expandedView);
     // Function to update the main canvas
    function updateCanvas(action = '') {
    
        const mainCanvas = expandedView.querySelector('.main-canvas');
    if (!action) {
      // Display placeholder text when no action has been taken and no tabs are used
      mainCanvas.innerHTML = `
        <div class="placeholder-text">
          <p>This is your working canvas.</p>
          <p>Please click on an action button to start.</p>
          <p>Then play around with the data sources by dragging tabs in.</p>
        </div>
      `;
    } else {
      // Display current progress when actions have been taken or tabs are used
      mainCanvas.innerHTML = `
        <h3>Current Progress</h3>
        <p>Last Action: ${action || 'None'}</p>
      `;
    }
  }

      updateCanvas(); // This will now show the placeholder text initially

    // Add click listeners to action buttons
    const actionButtonsContainer = expandedView.querySelector('.action-buttons');
    console.log(actionButtonsContainer)
    actionButtonsContainer.removeEventListener('click', actionButtonClickHandler);

    actionButtonsContainer.addEventListener('click', actionButtonClickHandler);

    const chatInput = expandedView.querySelector('.chat-input');
    chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        handleChatInput(expandedView, chatInput.value);
        chatInput.value = '';
      }
    });
  }


// New function to handle action button clicks
function actionButtonClickHandler(e) {
  if (e.target.classList.contains('action-button')) {
    console.log('Action button clicked:', e.target.textContent);
    handleActionClick(e.target.closest('.expanded-view'), e.target.textContent);
  }
}

// Initialize Showdown converter
const converter = new showdown.Converter();

let actionClickTimer = null;

// Update the handleActionClick function to use Showdown
async function handleActionClick(expandedView, action) {
 // Clear any existing timer
  if (actionClickTimer) {
    clearTimeout(actionClickTimer);
  }

  actionClickTimer = setTimeout(async () => {
        console.log('Handling action click:', action);
        lastSelectedAction = action; // Store the selected action

      const title = expandedView.querySelector('.expanded-title').textContent;
      const tabsUsed = Array.from(expandedView.querySelectorAll('.tabs-used .grouping-favicon')).map(favicon => ({
        url: favicon.src,
        title: favicon.alt
      }));

      try {
        showLoading();
        console.log('action click ',action)
        const response = await fetch(`${API_URL}/api/gpt`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            prompt: `Given the context "${title}", the following tabs: ${JSON.stringify(tabsUsed)}, and the selected action "${action}", provide a detailed response or plan. The response should be formatted in Markdown.`,
            tabs: tabsUsed,
            title: title
          })
        });

        if (!response.ok) {
          throw new Error('Failed to fetch action response');
        }
        console.log('done fetching')

        const data = await response.json();
        const actionResponse = data.choices[0].message.content;

        // Convert Markdown to HTML using Showdown
        const htmlResponse = converter.makeHtml(actionResponse);

        // Update the main canvas with the response
        const mainCanvas = expandedView.querySelector('.main-canvas');
        mainCanvas.innerHTML = `<div class="action-response">${htmlResponse}</div>`;
      } catch (error) {
        console.error('Error handling action click:', error);
      }finally {
        hideLoading();
      }

  }, 300); // 300ms debounce time
}
/*
async function handleSuggestedTabClick(expandedView, tabTitle) {
  // Add the suggested tab to the tabs used
  const tabsUsedContainer = expandedView.querySelector('.tabs-used');
  const newTab = document.createElement('div');
  newTab.classList.add('grouping-favicon');
  newTab.textContent = tabTitle.slice(0, 2).toUpperCase(); // Using initials as a placeholder
  newTab.title = tabTitle;
  tabsUsedContainer.appendChild(newTab);

  // Update suggestions and actions
  //updateExpandedView(expandedView);

  // Call handleActionClick with the last selected action
  if (lastSelectedAction) {
    await handleActionClick(expandedView, lastSelectedAction);
  }
}
*/

async function handleSuggestedTabClick(expandedView, tabButton) {
  const url = tabButton.dataset.url;
  const favicon = tabButton.dataset.favicon;
  const title = tabButton.textContent.trim();

  // Add the suggested tab to the tabs used
  const tabsUsedContainer = expandedView.querySelector('.tabs-used');
  const newTab = document.createElement('img');
  newTab.src = favicon;
  newTab.alt = title;
  newTab.title = url;
  newTab.classList.add('grouping-favicon');
  tabsUsedContainer.appendChild(newTab);

  // Call handleActionClick with the last selected action
  if (lastSelectedAction) {
    console.log('suggested tab', tabButton)
    await handleActionClick(expandedView, lastSelectedAction);
  }
}


  async function updateExpandedView(expandedView) {
      const title = expandedView.querySelector('.expanded-title').textContent;
      const tabsUsed = Array.from(expandedView.querySelectorAll('.tabs-used .grouping-favicon')).map(favicon => ({
        url: favicon.src || '',
        title: favicon.title
      }));

      // Update suggested tabs
      await populateSuggestedTabs(expandedView, title, tabsUsed);

      // Update actions
      try {
        const response = await fetch(`${API_URL}/api/gpt`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            prompt: `Given the grouping title "${title}" and the following tabs: ${JSON.stringify(tabsUsed)}, suggest 4 actions the user might want to take. Each action should be brief (3-5 words). Return only the actions, one per line.`,
            tabs: tabsUsed,
            title: title
          })
        });

        if (!response.ok) {
          throw new Error('Failed to fetch actions');
        }

        const data = await response.json();
        const actions = data.choices[0].message.content.split('\n').filter(action => action.trim() !== '');

        const actionButtons = expandedView.querySelector('.action-buttons');
        actionButtons.innerHTML = actions.map(action => `
          <button class="action-button">${action}</button>
        `).join('');

        // Add click event listeners to action buttons
        actionButtons.querySelectorAll('.action-button').forEach(button => {
          button.addEventListener('click', () => handleActionClick(expandedView, button.textContent));
        });
      } catch (error) {
        console.error('Error updating actions:', error);
      }
    }

    async function expandGrouping(grouping, expandedView) {
      const title = grouping.querySelector('.grouping-name').textContent;
      const tabsUsed = Array.from(grouping.querySelectorAll('.grouping-favicon')).map(favicon => ({
        url: favicon.src,
        title: favicon.alt
      }));

      expandedView.querySelector('.expanded-title').textContent = title;
      
      const tabsUsedContainer = expandedView.querySelector('.tabs-used');
      tabsUsedContainer.innerHTML = tabsUsed.map(tab => `
        <img src="${tab.url}" alt="${tab.title}" title="${tab.title}" class="grouping-favicon">
      `).join('');

      await updateExpandedView(expandedView);

      expandedView.classList.remove('hidden');
      document.querySelector('.groupings-container').classList.add('hidden');
    lastSelectedAction = '';

    }



  async function handleChatInput(expandedView, input) {
    // Implement chat functionality here
    console.log('Chat input:', input);
    handleActionClick(expandedView, input)
    // You can add logic to send this input to your backend and update the main canvas with the response
  }

  function minimizeGrouping(expandedView) {
    expandedView.classList.add('hidden');
    document.querySelector('.groupings-container').classList.remove('hidden');
  }
  function populateTabsUsed(expandedView, tabsUsed) {
    const tabsUsedContainer = expandedView.querySelector('.tabs-used');
    tabsUsedContainer.innerHTML = tabsUsed.map(tab => `
      <img src="${tab.url}" alt="${tab.title}" title="${tab.title}" class="grouping-favicon">
    `).join('');
  }

  function populateActions(expandedView, actions) {
    const actionButtons = expandedView.querySelector('.action-buttons');
    actionButtons.innerHTML = actions.map(action => `
      <button>${action}</button>
    `).join('');
  }

async function populateSuggestedTabs(expandedView, title, tabsUsed) {
  try {
    showLoading();
    const response = await fetch(`${API_URL}/api/gpt`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        prompt: `Given the grouping title "${title}" and the following tabs: ${JSON.stringify(tabsUsed)}
        , suggest 5 additional relevant urls and corresponding favicons for top level website. Return only the url links, and favicon url, comma separated, one per line.`,
        tabs: tabsUsed,
        title: title
      })
    });

    if (!response.ok) {
      throw new Error('Failed to fetch suggested tabs');
    }

    const data = await response.json();
    const suggestedTabs = data.choices[0].message.content.split('\n').filter(tab => tab.trim() !== '');

    const suggestedTabsContainer = expandedView.querySelector('.suggested-tabs');
    suggestedTabsContainer.innerHTML = suggestedTabs.map(tab => {
      const [url, favicon] = tab.split(',').map(item => item.trim());
      return `
        <button class="suggested-tab" data-url="${url}" data-favicon="${favicon}">
         <img src="${favicon}" alt="Favicon" class="suggested-tab-favicon">
          ${new URL(url).hostname}
        </button>
      `;
    }).join('');

    // Add click event listeners to suggested tabs
    suggestedTabsContainer.querySelectorAll('.suggested-tab').forEach(tabButton => {
      tabButton.addEventListener('click', () => handleSuggestedTabClick(expandedView, tabButton));
    });
  } catch (error) {
    console.error('Error fetching suggested tabs:', error);
  }finally {
    hideLoading();
  }
}

  async function fetchSuggestedTabs(title, tabsUsed) {
    try {
      const response = await fetch(`${API_URL}/api/suggested-tabs`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title, tabsUsed })
      });

      if (!response.ok) {
        throw new Error('Failed to fetch suggested tabs');
      }

      const data = await response.json();
      return data.suggestedTabs;
    } catch (error) {
      console.error('Error fetching suggested tabs:', error);
      return [];
    }
  }

  
  function setupDragAndDrop(expandedView) {
    const tabsUsedContainer = expandedView.querySelector('.tabs-used');
    
    tabsUsedContainer.addEventListener('dragover', (e) => e.preventDefault());
    tabsUsedContainer.addEventListener('drop', (e) => handleDrop(e, expandedView));
  }

  
// Modify the existing handleDrop function
async function handleDrop(e, expandedView) {
  e.preventDefault();
  const tabId = e.dataTransfer.getData('tabId');
  const favicon = e.dataTransfer.getData('favicon');
  const title = e.dataTransfer.getData('title');

  const newTab = { url: favicon, title: title };
  
  // Add the new tab to the tabs used
  const tabsUsedContainer = expandedView.querySelector('.tabs-used');
  const newFavicon = document.createElement('img');
  newFavicon.src = favicon;
  newFavicon.alt = title;
  newFavicon.title = title;
  newFavicon.classList.add('grouping-favicon');
  tabsUsedContainer.appendChild(newFavicon);

  // Remove the tab from the original list
  const tabToRemove = document.getElementById(tabId);
  if (tabToRemove) {
    tabToRemove.remove();
  }

  // Update the expanded view
  //await updateExpandedView(expandedView);

  // Call handleActionClick with the last selected action
  if (lastSelectedAction) {
    console.log('drop')
    await handleActionClick(expandedView, lastSelectedAction);
  }
}



// Initialize the app
document.addEventListener('DOMContentLoaded', () => {
    initializeAppWithSavedName();
    setupResetButton();

    if (!startButton.classList.contains('hidden')) {
        startButton.focus();
    }
});
    </script>
</body>
</html>
